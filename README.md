# E-Commerce Core System

> ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ì„ í¬í•¨í•œ ì´ì»¤ë¨¸ìŠ¤ í•µì‹¬ ê¸°ëŠ¥ êµ¬í˜„ í”„ë¡œì íŠ¸
> Spring Boot 3.5.7 + Java 17 + ë ˆì´ì–´ë“œ ì•„í‚¤í…ì²˜

## ğŸ“‹ ëª©ì°¨

- [í”„ë¡œì íŠ¸ ê°œìš”](#-í”„ë¡œì íŠ¸-ê°œìš”)
- [ì£¼ìš” ê¸°ëŠ¥](#-ì£¼ìš”-ê¸°ëŠ¥)
- [ì•„í‚¤í…ì²˜ ì„¤ê³„](#-ì•„í‚¤í…ì²˜-ì„¤ê³„)
- [ë™ì‹œì„± ì œì–´ ë°©ì‹ ë¶„ì„](#-ë™ì‹œì„±-ì œì–´-ë°©ì‹-ë¶„ì„)
- [í…ŒìŠ¤íŠ¸](#-í…ŒìŠ¤íŠ¸)

---

## ğŸ¯ í”„ë¡œì íŠ¸ ê°œìš”

ì´ì»¤ë¨¸ìŠ¤ ì‹œìŠ¤í…œì˜ í•µì‹¬ ê¸°ëŠ¥ì„ **ë ˆì´ì–´ë“œ ì•„í‚¤í…ì²˜**ë¡œ êµ¬í˜„í•œ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.
íŠ¹íˆ **ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰**ì˜ ë™ì‹œì„± ì œì–´ë¥¼ `java.util.concurrent` íŒ¨í‚¤ì§€ì˜ **Lock ë©”ì»¤ë‹ˆì¦˜**ìœ¼ë¡œ í•´ê²°í–ˆìŠµë‹ˆë‹¤.

### ê¸°ìˆ  ìŠ¤íƒ

- **ì–¸ì–´**: Java 17
- **í”„ë ˆì„ì›Œí¬**: Spring Boot 3.5.7
- **ë¹Œë“œ ë„êµ¬**: Gradle 8.x
- **í…ŒìŠ¤íŠ¸**: JUnit 5, AssertJ, Mockito
- **ë™ì‹œì„± ì œì–´**: ReentrantLock, ReadWriteLock, ConcurrentHashMap
- **ë°ì´í„° ì €ì¥**: ì¸ë©”ëª¨ë¦¬ (ConcurrentHashMap ê¸°ë°˜)

---

## ğŸš€ ì£¼ìš” ê¸°ëŠ¥

### 1. ìƒí’ˆ ê´€ë¦¬
- ìƒí’ˆ ëª©ë¡ ì¡°íšŒ (ì „ì²´/ì¹´í…Œê³ ë¦¬ë³„/ê°€ê²©ìˆœ)
- ì¬ê³  ì¡°íšŒ ë° ì‹¤ì‹œê°„ ì¶”ì 
- ì¸ê¸° ìƒí’ˆ ì§‘ê³„ (ìµœê·¼ 3ì¼, Top 5)

### 2. ì£¼ë¬¸/ê²°ì œ
- ì¥ë°”êµ¬ë‹ˆ ê¸°ëŠ¥ (ì¶”ê°€/ì¡°íšŒ/ì‚­ì œ)
- ì£¼ë¬¸ ìƒì„± ë° ì¬ê³  ì°¨ê°
- ì”ì•¡ ê¸°ë°˜ ê²°ì œ ì²˜ë¦¬
- ì¿ í° í• ì¸ ì ìš©

### 3. ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ â­
- **ë™ì‹œì„± ì œì–´**: ReentrantLock ê¸°ë°˜
- ì¬ê³  í•œì • ì¿ í° (ì„ ì°©ìˆœ 100ëª… ë“±)
- ì¤‘ë³µ ë°œê¸‰ ë°©ì§€
- ë§Œë£Œì¼ ê´€ë¦¬
- ì‚¬ìš© ì´ë ¥ ì¶”ì 

### 4. ì‚¬ìš©ì ê´€ë¦¬
- ì”ì•¡ ì¡°íšŒ ë° ì¶©ì „
- ì¿ í° ëª©ë¡ ì¡°íšŒ

---

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ ì„¤ê³„

### ë ˆì´ì–´ë“œ ì•„í‚¤í…ì²˜ (4ê³„ì¸µ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Presentation Layer                     â”‚  â† REST API Controller
â”‚   (Controller)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Application Layer                      â”‚  â† UseCase (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)
â”‚   (UseCase)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Domain Layer                           â”‚  â† Entity, VO, Repository Interface
â”‚   (Entity, VO, Domain Service)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Infrastructure Layer                   â”‚  â† Repository êµ¬í˜„ì²´ (InMemory)
â”‚   (Repository Implementation)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
src/main/java/com/sparta/ecommerce/
â”œâ”€â”€ presentation/
â”‚   â””â”€â”€ controller/          # REST API Endpoint
â”‚       â”œâ”€â”€ product/
â”‚       â”œâ”€â”€ order/
â”‚       â”œâ”€â”€ coupon/
â”‚       â””â”€â”€ user/
â”‚
â”œâ”€â”€ application/             # UseCase (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)
â”‚   â”œâ”€â”€ product/
â”‚   â”‚   â”œâ”€â”€ GetProductsUseCase.java
â”‚   â”‚   â””â”€â”€ GetPopularProductsUseCase.java
â”‚   â”œâ”€â”€ order/
â”‚   â”‚   â””â”€â”€ CreateOrderUseCase.java
â”‚   â””â”€â”€ coupon/
â”‚       â””â”€â”€ IssueCouponUseCase.java  â† ë™ì‹œì„± ì œì–´ í•µì‹¬
â”‚
â”œâ”€â”€ domain/                  # ë„ë©”ì¸ ëª¨ë¸
â”‚   â”œâ”€â”€ product/
â”‚   â”‚   â”œâ”€â”€ Product.java             (Entity)
â”‚   â”‚   â”œâ”€â”€ vo/Stock.java            (Value Object)
â”‚   â”‚   â””â”€â”€ ProductRepository.java   (Interface)
â”‚   â”œâ”€â”€ coupon/
â”‚   â”‚   â”œâ”€â”€ Coupon.java
â”‚   â”‚   â”œâ”€â”€ UserCoupon.java
â”‚   â”‚   â”œâ”€â”€ vo/CouponStock.java
â”‚   â”‚   â””â”€â”€ CouponRepository.java
â”‚   â””â”€â”€ order/
â”‚       â”œâ”€â”€ Order.java
â”‚       â””â”€â”€ OrderRepository.java
â”‚
â””â”€â”€ infrastructure/
    â””â”€â”€ memory/              # InMemory Repository êµ¬í˜„
        â”œâ”€â”€ InMemoryDataStore.java       â† ConcurrentHashMap
        â”œâ”€â”€ InMemoryCouponRepository.java
        â””â”€â”€ InMemoryProductRepository.java
```

---

## ğŸ”’ ë™ì‹œì„± ì œì–´ ë°©ì‹ ë¶„ì„

### ğŸ“Œ ë¬¸ì œ ì •ì˜

**ì‹œë‚˜ë¦¬ì˜¤**: ì„ ì°©ìˆœ 100ëª… í•œì • ì¿ í° ë°œê¸‰ ì‹œ 1000ëª…ì´ ë™ì‹œì— ìš”ì²­

**ë°œìƒ ê°€ëŠ¥í•œ ë¬¸ì œ (Race Condition)**
```java
// âŒ ë™ì‹œì„± ì œì–´ ì—†ì„ ë•Œ
Thread A: if (stock > 0) { stock--; }  // stock = 1 ì½ìŒ
Thread B: if (stock > 0) { stock--; }  // stock = 1 ì½ìŒ (ë™ì‹œì—!)
// ê²°ê³¼: stock = -1 (Over-issuance ë°œìƒ!)
```

**ê²°ê³¼**:
- Over-issuance: ì¬ê³  100ê°œì¸ë° 101ê°œ ë°œê¸‰
- ì¤‘ë³µ ë°œê¸‰: ê°™ì€ ì‚¬ìš©ìê°€ 2ë²ˆ ë°œê¸‰ë°›ìŒ
- Lost Update: ì¬ê³  ì—…ë°ì´íŠ¸ ì†ì‹¤

---

### âœ… ì„ íƒí•œ ë°©ì‹: ReentrantLock + ReadWriteLock

#### 1. **ì¿ í°ë³„ ê°œë³„ Lock ê´€ë¦¬ (Fine-Grained Locking)**

```java
@Service
public class IssueCouponUseCase {

    // ì¿ í° IDë³„ë¡œ ê°œë³„ Lock ìƒì„±
    private final ConcurrentHashMap<String, Lock> couponLocks = new ConcurrentHashMap<>();

    public UserCouponResponse execute(String userId, String couponId) {
        // 1. ì¿ í°ë³„ Lock íšë“ (Fair Lock - FIFO)
        Lock lock = couponLocks.computeIfAbsent(couponId,
            k -> new ReentrantLock(true));

        // 2. Lock íšë“ ì‹œë„ (10ì´ˆ íƒ€ì„ì•„ì›ƒ)
        boolean acquired = lock.tryLock(10, TimeUnit.SECONDS);

        if (!acquired) {
            throw new CouponIssueLockException(couponId, 10);
        }

        try {
            // 3. Critical Section (ì„ê³„ ì˜ì—­)
            // - ì¿ í° ì¡°íšŒ
            // - ì¤‘ë³µ ë°œê¸‰ ì²´í¬
            // - ì¬ê³  ì°¨ê°
            // - ì‚¬ìš©ì ì¿ í° ë°œê¸‰
            return issueCouponWithLock(userId, couponId);
        } finally {
            // 4. Lock í•´ì œ (ë°˜ë“œì‹œ ì‹¤í–‰)
            lock.unlock();
        }
    }
}
```

**í•µì‹¬ íŠ¹ì§•:**
- **ì¿ í°ë³„ ê°œë³„ Lock**: C001, C002 ë°œê¸‰ì€ ì„œë¡œ ë‹¤ë¥¸ Lock ì‚¬ìš©
- **ë³‘ë ¬ ì²˜ë¦¬ ê°€ëŠ¥**: ì„œë¡œ ë‹¤ë¥¸ ì¿ í°ì€ ë™ì‹œ ë°œê¸‰ ê°€ëŠ¥
- **Fair Lock**: `new ReentrantLock(true)` - FIFO ìˆœì„œ ë³´ì¥

#### 2. **ReadWriteLockìœ¼ë¡œ Repository ìµœì í™”**

```java
@Repository
public class InMemoryCouponRepository implements CouponRepository {

    private final ReadWriteLock lock = new ReentrantReadWriteLock();

    // ì½ê¸°: ì—¬ëŸ¬ ìŠ¤ë ˆë“œ ë™ì‹œ ì‹¤í–‰ ê°€ëŠ¥
    public Optional<Coupon> findById(String id) {
        lock.readLock().lock();
        try {
            return Optional.ofNullable(dataStore.getCoupons().get(id));
        } finally {
            lock.readLock().unlock();
        }
    }

    // ì“°ê¸°: ë°°íƒ€ì  ì‹¤í–‰ (ë¹„ê´€ì  ë½)
    public Optional<Coupon> findByIdWithLock(String id) {
        lock.writeLock().lock();  // SELECT FOR UPDATE ì‹œë®¬ë ˆì´ì…˜
        try {
            return Optional.ofNullable(dataStore.getCoupons().get(id));
        } finally {
            lock.writeLock().unlock();
        }
    }
}
```

**ì„±ëŠ¥ ìµœì í™”:**
- **Read Lock**: ì¡°íšŒëŠ” ì—¬ëŸ¬ ìŠ¤ë ˆë“œ ë™ì‹œ ì‹¤í–‰
- **Write Lock**: ë°œê¸‰/ìˆ˜ì •ì€ ë°°íƒ€ì  ì‹¤í–‰
- **Pessimistic Lock ì‹œë®¬ë ˆì´ì…˜**: DBì˜ `SELECT FOR UPDATE`ì™€ ë™ì¼

---

### ğŸ“Š ì¥ë‹¨ì  ë¶„ì„

#### âœ… ì¥ì 

| í•­ëª© | ì„¤ëª… |
|------|------|
| **ë³‘ë ¬ì„± í–¥ìƒ** | ì¿ í°ë³„ ê°œë³„ Lockìœ¼ë¡œ C001, C002 ë™ì‹œ ë°œê¸‰ ê°€ëŠ¥ |
| **ê³µì •ì„± ë³´ì¥** | Fair Lockìœ¼ë¡œ ì„ ì°©ìˆœ ìˆœì„œ ë³´ì¥ (FIFO) |
| **íƒ€ì„ì•„ì›ƒ ì§€ì›** | `tryLock(timeout)` - ë¬´í•œ ëŒ€ê¸° ë°©ì§€ |
| **ì„¸ë°€í•œ ì œì–´** | lock/unlock ì‹œì  ëª…ì‹œì  ì œì–´ ê°€ëŠ¥ |
| **ì½ê¸° ìµœì í™”** | ReadWriteLockìœ¼ë¡œ ì½ê¸° ì‘ì—… ë³‘ë ¬ ì²˜ë¦¬ |
| **ì˜ˆì™¸ ì•ˆì „ì„±** | finally ë¸”ë¡ì—ì„œ unlock ë³´ì¥ |

#### âŒ ë‹¨ì 

| í•­ëª© | ì„¤ëª… | í•´ê²° ë°©ì•ˆ |
|------|------|----------|
| **ë©”ëª¨ë¦¬ ì‚¬ìš©** | ì¿ í°ë§ˆë‹¤ Lock ê°ì²´ ìƒì„± | ì‚¬ìš© ë¹ˆë„ ë‚®ì€ Lock ì£¼ê¸°ì  ì •ë¦¬ |
| **ë‹¨ì¼ ì„œë²„ í•œì •** | ë©€í‹° ì„œë²„ í™˜ê²½ ë¯¸ì§€ì› | Redis ë¶„ì‚° ë½ ì „í™˜ í•„ìš” |
| **ë³µì¡ë„ ì¦ê°€** | synchronizedë³´ë‹¤ ì½”ë“œ ë³µì¡ | ëª…í™•í•œ ì£¼ì„ ë° ë¬¸ì„œí™” |
| **Fairness ì„±ëŠ¥** | Fair Lockì€ ì²˜ë¦¬ëŸ‰ ê°ì†Œ | ê³µì •ì„± vs ì„±ëŠ¥ íŠ¸ë ˆì´ë“œì˜¤í”„ |

---

### ğŸ”„ ëŒ€ì•ˆ ë°©ì‹ ë¹„êµ

#### 1. **synchronized í‚¤ì›Œë“œ**

```java
// ë©”ì„œë“œ ì „ì²´ì— ë½
public synchronized UserCouponResponse execute(String userId, String couponId) {
    // ëª¨ë“  ì¿ í° ë°œê¸‰ì´ ìˆœì°¨ ì²˜ë¦¬ë¨
}
```

| ë¹„êµ í•­ëª© | synchronized | ReentrantLock (ì„ íƒ) |
|----------|--------------|---------------------|
| **ë³‘ë ¬ì„±** | âŒ ì „ì²´ ë©”ì„œë“œ ë½ | âœ… ì¿ í°ë³„ ê°œë³„ ë½ |
| **íƒ€ì„ì•„ì›ƒ** | âŒ ì§€ì› ì•ˆ í•¨ | âœ… tryLock(timeout) |
| **ê³µì •ì„±** | âŒ ë¶ˆí™•ì‹¤ | âœ… Fair Lock ì§€ì› |
| **ì„±ëŠ¥** | C001, C002 ìˆœì°¨ ì‹¤í–‰ | C001, C002 ë³‘ë ¬ ì‹¤í–‰ |
| **ì‚¬ìš©ì„±** | âœ… ê°„ë‹¨ | âŒ ë³µì¡ (try-finally) |

**ê²°ë¡ **: ì„±ëŠ¥ê³¼ ì„¸ë°€í•œ ì œì–´ê°€ í•„ìš”í•œ ê²½ìš° ReentrantLock ìš°ìœ„

---

#### 2. **ë‚™ê´€ì  ë½ (Optimistic Lock)**

```java
// Version ê¸°ë°˜ ë‚™ê´€ì  ë½
@Entity
public class Coupon {
    @Version
    private Long version;
}

// ì¶©ëŒ ì‹œ ì¬ì‹œë„
while (retryCount < MAX_RETRY) {
    try {
        coupon.decreaseStock();
        couponRepository.save(coupon);  // version ì²´í¬
        break;
    } catch (OptimisticLockException e) {
        retryCount++;
    }
}
```

| ë¹„êµ í•­ëª© | ë‚™ê´€ì  ë½ | ë¹„ê´€ì  ë½ (ì„ íƒ) |
|----------|----------|-----------------|
| **ì² í•™** | "ì¶©ëŒ ê±°ì˜ ì—†ì„ ê²ƒ" | "ì¶©ëŒ ìì£¼ ì¼ì–´ë‚  ê²ƒ" |
| **ë½ ì‹œì ** | ì €ì¥ ì‹œ version ì²´í¬ | ì¡°íšŒ ì‹œ ì¦‰ì‹œ ë½ íšë“ |
| **ì„±ëŠ¥** | âœ… ë½ ì˜¤ë²„í—¤ë“œ ì—†ìŒ | âŒ ë½ ëŒ€ê¸° ì‹œê°„ ë°œìƒ |
| **ì¶©ëŒ ì²˜ë¦¬** | âŒ ì¬ì‹œë„ ë¡œì§ í•„ìš” | âœ… ì• ì´ˆì— ì¶©ëŒ ë°©ì§€ |
| **ì í•©í•œ ê²½ìš°** | ì½ê¸° ë§ê³  ì“°ê¸° ì ìŒ | ì“°ê¸° ê²½í•©ì´ ë†’ìŒ |

**ì„ ì°©ìˆœ ì¿ í°ì˜ ê²½ìš°**:
- âŒ ë‚™ê´€ì  ë½: 100ëª… í•œì •ì¸ë° 1000ëª… ìš”ì²­ â†’ 900ë²ˆ ì¬ì‹œë„ ë°œìƒ
- âœ… ë¹„ê´€ì  ë½: ì• ì´ˆì— ìˆœì°¨ ì²˜ë¦¬ë¡œ ì¶©ëŒ ë°©ì§€

---

#### 3. **Semaphore (ì„¸ë§ˆí¬ì–´)**

```java
// ë™ì‹œ ì‹¤í–‰ ìˆ˜ ì œí•œ
private final Semaphore semaphore = new Semaphore(10);

public UserCouponResponse execute(String userId, String couponId) {
    semaphore.acquire();  // ìµœëŒ€ 10ê°œ ìŠ¤ë ˆë“œë§Œ ì‹¤í–‰
    try {
        // ì¿ í° ë°œê¸‰ ë¡œì§
    } finally {
        semaphore.release();
    }
}
```

| ë¹„êµ í•­ëª© | Semaphore | ReentrantLock (ì„ íƒ) |
|----------|-----------|---------------------|
| **ëª©ì ** | ë™ì‹œ ì‹¤í–‰ ìˆ˜ ì œí•œ | ìƒí˜¸ ë°°ì œ (Mutual Exclusion) |
| **ì í•©í•œ ê²½ìš°** | ë¦¬ì†ŒìŠ¤ í’€ ê´€ë¦¬ (ì»¤ë„¥ì…˜ í’€) | ê³µìœ  ë°ì´í„° ë³´í˜¸ |
| **ì¿ í° ë°œê¸‰** | âŒ Race Condition í•´ê²° ëª»í•¨ | âœ… ì¬ê³  ì¼ê´€ì„± ë³´ì¥ |

**ê²°ë¡ **: SemaphoreëŠ” ë™ì‹œ ì‹¤í–‰ ìˆ˜ë§Œ ì œí•œ, ì¬ê³  ì¼ê´€ì„±ì€ ë³´ì¥ ëª»í•¨

---

#### 4. **AtomicInteger (Lock-Free)**

```java
private final AtomicInteger stock = new AtomicInteger(100);

// CAS (Compare-And-Swap) ì—°ì‚°
int current = stock.get();
if (current > 0 && stock.compareAndSet(current, current - 1)) {
    // ë°œê¸‰ ì„±ê³µ
}
```

| ë¹„êµ í•­ëª© | AtomicInteger | ReentrantLock (ì„ íƒ) |
|----------|--------------|---------------------|
| **ì„±ëŠ¥** | âœ… Lockë³´ë‹¤ ë¹ ë¦„ | âŒ Context Switch ë°œìƒ |
| **ë³µì¡ì„±** | âŒ ë‹¨ìˆœ ì—°ì‚°ë§Œ ê°€ëŠ¥ | âœ… ë³µì¡í•œ ë¡œì§ ë³´í˜¸ ê°€ëŠ¥ |
| **ì¿ í° ë°œê¸‰** | âŒ ì¬ê³ ë§Œ ë³´í˜¸ (ì¤‘ë³µ ë°œê¸‰ ë¯¸ë°©ì§€) | âœ… ì „ì²´ ë°œê¸‰ í”„ë¡œì„¸ìŠ¤ ë³´í˜¸ |

**ì„ ì°©ìˆœ ì¿ í°ì˜ ê²½ìš°**:
- ì¬ê³  ì°¨ê° + ì¤‘ë³µ ì²´í¬ + ì‚¬ìš©ì ì¿ í° ë°œê¸‰ â†’ **ì—¬ëŸ¬ ë‹¨ê³„ì˜ ì›ìì„± í•„ìš”**
- AtomicIntegerëŠ” ë‹¨ì¼ ë³€ìˆ˜ë§Œ ë³´í˜¸ â†’ ë¶€ì í•©

---

#### 5. **Redis ë¶„ì‚° ë½ (Redisson)**

```java
// ë©€í‹° ì„œë²„ í™˜ê²½
RLock lock = redisson.getLock("coupon:" + couponId);

try {
    if (lock.tryLock(10, 3, TimeUnit.SECONDS)) {
        // ì¿ í° ë°œê¸‰ ë¡œì§
    }
} finally {
    lock.unlock();
}
```

| ë¹„êµ í•­ëª© | Redis ë¶„ì‚° ë½ | ReentrantLock (ì„ íƒ) |
|----------|--------------|---------------------|
| **ë©€í‹° ì„œë²„** | âœ… ì§€ì› | âŒ ë‹¨ì¼ JVMë§Œ |
| **ì„±ëŠ¥** | âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë²„í—¤ë“œ | âœ… ë©”ëª¨ë¦¬ ë‚´ ì²˜ë¦¬ |
| **ì˜ì¡´ì„±** | âŒ Redis í•„ìš” | âœ… JDK ê¸°ë³¸ ì œê³µ |
| **ë³µì¡ë„** | âŒ ì¸í”„ë¼ ê´€ë¦¬ | âœ… ê°„ë‹¨ |

**í˜„ì¬ í”„ë¡œì íŠ¸**: ë‹¨ì¼ ì„œë²„ ì¸ë©”ëª¨ë¦¬ í™˜ê²½ â†’ ReentrantLock ì í•©
**í”„ë¡œë•ì…˜**: ë©€í‹° ì„œë²„ í™˜ê²½ â†’ Redis ë¶„ì‚° ë½ í•„ìš”

---

### ğŸ¯ ìµœì¢… ì„ íƒ ì´ìœ 

**í˜„ì¬ êµ¬í˜„: ReentrantLock + ReadWriteLock**

```
1. ì¿ í°ë³„ ê°œë³„ Lock (Fine-Grained Locking)
   â””â”€> C001, C002 ë³‘ë ¬ ì²˜ë¦¬ ê°€ëŠ¥ (ì„±ëŠ¥ í–¥ìƒ)

2. Fair Lock (ê³µì •ì„±)
   â””â”€> ì„ ì°©ìˆœ ìˆœì„œ ë³´ì¥ (FIFO)

3. Timeout ì„¤ì •
   â””â”€> 10ì´ˆ ëŒ€ê¸° í›„ ëª…í™•í•œ ì˜ˆì™¸ ë©”ì‹œì§€

4. ReadWriteLock (ì½ê¸° ìµœì í™”)
   â””â”€> ì¡°íšŒëŠ” ë™ì‹œ ì‹¤í–‰, ë°œê¸‰ì€ ë°°íƒ€ì  ì‹¤í–‰

5. ë¹„ê´€ì  ë½ ì‹œë®¬ë ˆì´ì…˜
   â””â”€> DB SELECT FOR UPDATEì™€ ë™ì¼í•œ ë™ì‘
```

**íŠ¸ë ˆì´ë“œì˜¤í”„:**
- âœ… ì„±ëŠ¥ê³¼ ê³µì •ì„± í™•ë³´
- âŒ synchronizedë³´ë‹¤ ë³µì¡í•œ ì½”ë“œ
- âŒ ë‹¨ì¼ ì„œë²„ í™˜ê²½ë§Œ ì§€ì› (í–¥í›„ Redisë¡œ ì „í™˜ ê°€ëŠ¥)

---

### ğŸ“ˆ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼

#### í…ŒìŠ¤íŠ¸ í™˜ê²½
- **ìŠ¤ë ˆë“œ ìˆ˜**: 100ê°œ
- **ì¿ í° ì¬ê³ **: 50ê°œ
- **í…ŒìŠ¤íŠ¸ ë°©ì‹**: `ExecutorService` + `CountDownLatch`

#### ê²°ê³¼

| í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ | ê¸°ëŒ€ ê²°ê³¼ | ì‹¤ì œ ê²°ê³¼ | ìƒíƒœ |
|---------------|----------|----------|------|
| 100ëª… ë™ì‹œ ë°œê¸‰, ì¬ê³  50 | 50ëª… ì„±ê³µ, 50ëª… ì‹¤íŒ¨ | 50ëª… ì„±ê³µ, 50ëª… ì‹¤íŒ¨ | âœ… í†µê³¼ |
| ë™ì¼ ì‚¬ìš©ì 10ë²ˆ ì‹œë„ | 1ë²ˆë§Œ ì„±ê³µ | 1ë²ˆë§Œ ì„±ê³µ | âœ… í†µê³¼ |
| 1000ëª… ê³ ë¶€í•˜, ì¬ê³  100 | 100ëª… ì„±ê³µ, Over-issuance ì—†ìŒ | 100ëª… ì„±ê³µ | âœ… í†µê³¼ |
| C001, C002 ë³‘ë ¬ ë°œê¸‰ | ê°ê° 50ê°œì”© ë°œê¸‰ | ê°ê° 50ê°œì”© ë°œê¸‰ | âœ… í†µê³¼ |

**ê²€ì¦ í•­ëª©:**
- âœ… Over-issuance ë°©ì§€ (ì¬ê³  ì´ˆê³¼ ë°œê¸‰ ì—†ìŒ)
- âœ… ì¤‘ë³µ ë°œê¸‰ ë°©ì§€ (1ì¸ 1ì¿ í°)
- âœ… Race Condition í•´ê²° (ìµœì¢… ì¬ê³  ì •í™•)
- âœ… ë³‘ë ¬ ì²˜ë¦¬ (ì„œë¡œ ë‹¤ë¥¸ ì¿ í°ì€ ë™ì‹œ ì‹¤í–‰)

---

### ğŸ”® í–¥í›„ ê°œì„  ë°©í–¥

#### 1. **Redis ë¶„ì‚° ë½ ì „í™˜**
```java
// Redisson ì‚¬ìš©
@Service
public class IssueCouponUseCase {
    private final RedissonClient redisson;

    public UserCouponResponse execute(String userId, String couponId) {
        RLock lock = redisson.getLock("coupon:" + couponId);

        try {
            lock.lock(10, TimeUnit.SECONDS);
            // ì¿ í° ë°œê¸‰ ë¡œì§
        } finally {
            lock.unlock();
        }
    }
}
```
**ì¥ì **: ë©€í‹° ì„œë²„ í™˜ê²½ ì§€ì›, ìˆ˜í‰ í™•ì¥ ê°€ëŠ¥

#### 2. **DB SELECT FOR UPDATE ì‚¬ìš©**
```sql
-- ì‹¤ì œ DB í™˜ê²½
SELECT * FROM coupon
WHERE coupon_id = ?
FOR UPDATE;
```
**ì¥ì **: íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ í™œìš©, ì˜ì†ì„± ë³´ì¥

#### 3. **ë©”ì‹œì§€ í ê¸°ë°˜ ì²˜ë¦¬**
```
User Request â†’ Queue â†’ Worker (ìˆœì°¨ ì²˜ë¦¬)
```
**ì¥ì **: ìš”ì²­ í‰ì¤€í™”, ì‹œìŠ¤í…œ ì•ˆì •ì„± í–¥ìƒ

#### 4. **Lock-Free ì•Œê³ ë¦¬ì¦˜ ì—°êµ¬**
- CAS (Compare-And-Swap) ê¸°ë°˜ êµ¬í˜„
- `AtomicReference`ë¡œ ë¶ˆë³€ ê°ì²´ êµì²´

---

## ğŸƒ ì‹¤í–‰ ë°©ë²•

### API ì—”ë“œí¬ì¸íŠ¸
```bash
# ìƒí’ˆ ëª©ë¡ ì¡°íšŒ
GET http://localhost:8080/api/products

# ì¿ í° ë°œê¸‰ (ë™ì‹œì„± ì œì–´ ì ìš©)
POST http://localhost:8080/api/coupons/{couponId}/issue
Body: { "userId": "U001" }

# ì£¼ë¬¸ ìƒì„±
POST http://localhost:8080/api/orders
Body: { "userId": "U001", "couponId": "C001" }
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸

### í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€
- **ì „ì²´ ì»¤ë²„ë¦¬ì§€**: 85% ì´ìƒ
- **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸**: 60ê°œ ì´ìƒ
- **ë™ì‹œì„± í…ŒìŠ¤íŠ¸**: 4ê°œ ì‹œë‚˜ë¦¬ì˜¤

### ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰
```bash
# ì¿ í° ë°œê¸‰ ë™ì‹œì„± í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
./gradlew test --tests "IssueCouponConcurrencyTest"

# ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
./gradlew test
```

### ì£¼ìš” í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤
- `IssueCouponConcurrencyTest`: ë™ì‹œì„± ì œì–´ ê²€ì¦
- `IssueCouponUseCaseTest`: ì¿ í° ë°œê¸‰ ë¡œì§ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- `CreateOrderUseCaseTest`: ì£¼ë¬¸ ìƒì„± ë¡œì§ í…ŒìŠ¤íŠ¸
---
