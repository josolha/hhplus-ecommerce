# k6 ë¶€í•˜ í…ŒìŠ¤íŠ¸ êµ¬ì¶• ë° ë¬¸ì œ í•´ê²° ë³´ê³ ì„œ - ì”ì•¡ ì¶©ì „

**ì‘ì„±ì¼**: 2025-12-26
**í”„ë¡œì íŠ¸**: E-commerce Core - ì”ì•¡ ì¶©ì „ ì‹œìŠ¤í…œ
**ëª©ì **: ì”ì•¡ ì¶©ì „ APIì˜ ë™ì‹œì„± ì œì–´ ë° ì„±ëŠ¥ ê²€ì¦

---

## ğŸ“‹ ëª©ì°¨

1. [í”„ë¡œì íŠ¸ ê°œìš”](#í”„ë¡œì íŠ¸-ê°œìš”)
2. [ì´ˆê¸° ë¬¸ì œ ìƒí™©](#ì´ˆê¸°-ë¬¸ì œ-ìƒí™©)
3. [ë¬¸ì œ í•´ê²° ê³¼ì •](#ë¬¸ì œ-í•´ê²°-ê³¼ì •)
4. [ìµœì¢… í…ŒìŠ¤íŠ¸ ê²°ê³¼](#ìµœì¢…-í…ŒìŠ¤íŠ¸-ê²°ê³¼)
5. [í•µì‹¬ ê°œì„  ì‚¬í•­](#í•µì‹¬-ê°œì„ -ì‚¬í•­)
6. [ê²°ë¡  ë° ê¶Œì¥ì‚¬í•­](#ê²°ë¡ -ë°-ê¶Œì¥ì‚¬í•­)

---

## í”„ë¡œì íŠ¸ ê°œìš”

### í…ŒìŠ¤íŠ¸ ëŒ€ìƒ
- **API**: ì”ì•¡ ì¶©ì „ (POST `/api/users/{userId}/balance/charge`)
- **ë™ì‹œì„± ì œì–´**: Pessimistic Lock (ë¹„ê´€ì  ì ê¸ˆ)
- **ëª©í‘œ**: ë™ì¼ ì‚¬ìš©ìì˜ ë™ì‹œ ì¶©ì „ ìš”ì²­ ì²˜ë¦¬ ë° ë°ì´í„° ì •í•©ì„± ë³´ì¥

### í…ŒìŠ¤íŠ¸ í™˜ê²½
- **ë¶€í•˜ í…ŒìŠ¤íŠ¸ ë„êµ¬**: k6 (Grafana Labs)
- **ë°ì´í„°ë² ì´ìŠ¤**: MySQL 8.0
- **ë™ì‹œì„± ì œì–´**: JPA `@Lock(LockModeType.PESSIMISTIC_WRITE)`
- **í…ŒìŠ¤íŠ¸ ë°ì´í„°**: LoadTestDataSeeder (100,000ëª… ìœ ì €)

---

## ì´ˆê¸° ë¬¸ì œ ìƒí™©

### ë¬¸ì œ: ì—ëŸ¬ìœ¨ 26.78% ğŸ”´

**ì²« ë²ˆì§¸ í…ŒìŠ¤íŠ¸ ê²°ê³¼:**
```
ì´ ìš”ì²­: 153,763ê±´
ì—ëŸ¬ìœ¨: 26.78% (41,186ê±´ ì‹¤íŒ¨)
HTTP ì‹¤íŒ¨ìœ¨: 0%
ì„±ê³µí•œ ì¶©ì „: 112,577ê±´
```

**ì›ì¸ ë¶„ì„:**

#### 1. API ì‘ë‹µ êµ¬ì¡° í™•ì¸
```java
// ChargeBalanceResponse.java
public record ChargeBalanceResponse(
    String userId,
    Long previousBalance,
    Long chargedAmount,
    Long currentBalance,     // â† ì‹¤ì œ í•„ë“œëª…
    LocalDateTime chargedAt
)
```

ì‹¤ì œ API ì‘ë‹µ:
```json
{
  "userId": "test-user-1",
  "previousBalance": 2000000,
  "chargedAmount": 50000,
  "currentBalance": 2050000,   // â† ì‹¤ì œë¡œ ë°˜í™˜ë˜ëŠ” í•„ë“œ
  "chargedAt": "2025-12-26T10:30:00"
}
```

#### 2. k6 í…ŒìŠ¤íŠ¸ ê²€ì¦ ë¡œì§
```javascript
// balance-charge-test.js:102-109
'response has balance': (r) => {
  try {
    const body = JSON.parse(r.body);
    return body.balance !== undefined;  // âŒ ì˜ëª»ëœ í•„ë“œëª…
  } catch (e) {
    return false;
  }
}
```

**í•µì‹¬ ë¬¸ì œ:**
- **k6 í…ŒìŠ¤íŠ¸ê°€ ì°¾ëŠ” í•„ë“œ**: `body.balance`
- **ì‹¤ì œ API ì‘ë‹µ í•„ë“œ**: `body.currentBalance`
- **ê²°ê³¼**: í•„ë“œëª… ë¶ˆì¼ì¹˜ë¡œ 41,186ê±´ì˜ ì²´í¬ ì‹¤íŒ¨ ë°œìƒ

#### 3. ìƒì„¸ ì—ëŸ¬ ë¶„ì„

balance-charge-summary.json ê²°ê³¼:
```json
{
  "checks": [
    {
      "name": "charge status is 200",
      "passes": 153763,     // âœ… ëª¨ë“  HTTP ìš”ì²­ ì„±ê³µ
      "fails": 0
    },
    {
      "name": "response has balance",
      "passes": 0,          // âŒ ëª¨ë“  ì²´í¬ ì‹¤íŒ¨
      "fails": 41186        // concurrentChargeTest ì‹œë‚˜ë¦¬ì˜¤ ì „ì²´ ì‹¤íŒ¨
    }
  ],
  "metrics": {
    "errors": {
      "rate": 0.2678537749653688,  // 26.78% ì—ëŸ¬ìœ¨
      "passes": 41186,
      "fails": 112577
    }
  }
}
```

**ì™œ 41,186ê±´ë§Œ ì‹¤íŒ¨í–ˆë‚˜?**
- `concurrentChargeTest` ì‹œë‚˜ë¦¬ì˜¤: ì•½ 41,186ë²ˆ ì‹¤í–‰ (1ë¶„ ë™ì•ˆ 100 VU)
  - HTTP ìš”ì²­ì€ 200 OKë¡œ ì„±ê³µ
  - "response has balance" ì²´í¬ë§Œ ì‹¤íŒ¨ (ì˜ëª»ëœ í•„ë“œëª…)
- `loadTest` ì‹œë‚˜ë¦¬ì˜¤: ì•½ 112,577ë²ˆ ì‹¤í–‰ (4ë¶„ ë™ì•ˆ 50-150 VU)
  - balance í•„ë“œ ì²´í¬ë¥¼ í•˜ì§€ ì•ŠìŒ
  - ëª¨ë‘ ì„±ê³µ

---

## ë¬¸ì œ í•´ê²° ê³¼ì •

### í•´ê²° 1: ì‘ë‹µ í•„ë“œëª… ìˆ˜ì •

#### balance-charge-test.js ìˆ˜ì • (Line 105)
```javascript
// Before (âŒ)
'response has balance': (r) => {
  try {
    const body = JSON.parse(r.body);
    return body.balance !== undefined;  // âŒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í•„ë“œ
  } catch (e) {
    return false;
  }
}

// After (âœ…)
'response has balance': (r) => {
  try {
    const body = JSON.parse(r.body);
    return body.currentBalance !== undefined;  // âœ… ì‹¤ì œ í•„ë“œëª…
  } catch (e) {
    return false;
  }
}
```

**íš¨ê³¼:**
- API ì‘ë‹µ êµ¬ì¡°ì™€ í…ŒìŠ¤íŠ¸ ê²€ì¦ ë¡œì§ ì¼ì¹˜
- ì²´í¬ ì‹¤íŒ¨ 41,186ê±´ â†’ 0ê±´

---

### í•´ê²° 2: ì½˜ì†” ë¡œê·¸ ì¶œë ¥ ìˆ˜ì •

#### balance-charge-test.js ìˆ˜ì • (Line 119)
```javascript
// Before (âŒ)
console.log(`[ì¶©ì „ ì„±ê³µ] userId: ${userId}, amount: ${amount}, balance: ${data.balance}`);

// After (âœ…)
console.log(`[ì¶©ì „ ì„±ê³µ] userId: ${userId}, amount: ${amount}, balance: ${data.currentBalance}`);
```

**íš¨ê³¼:**
- ì½˜ì†” ë¡œê·¸ì— ì‹¤ì œ ì”ì•¡ ì •ìƒ ì¶œë ¥
- í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ ë””ë²„ê¹… ìš©ì´ì„± í–¥ìƒ

---

### í•´ê²° 3: Summary í•¨ìˆ˜ í†µê³„ ìˆ˜ì •

#### balance-charge-test.js ìˆ˜ì • (Line 235-241)
```javascript
// Before (âŒ)
ì‘ë‹µ ì‹œê°„:
  - p(50): ${(data.metrics.http_req_duration?.values['p(50)'] || 0).toFixed(2)}ms   // âŒ ì¡´ì¬í•˜ì§€ ì•ŠìŒ
  - p(95): ${(data.metrics.http_req_duration?.values['p(95)'] || 0).toFixed(2)}ms
  - p(99): ${(data.metrics.http_req_duration?.values['p(99)'] || 0).toFixed(2)}ms   // âŒ ì¡´ì¬í•˜ì§€ ì•ŠìŒ

// After (âœ…)
ì‘ë‹µ ì‹œê°„:
  - p(50): ${(data.metrics.http_req_duration?.values.med || 0).toFixed(2)}ms        // âœ… ì¤‘ì•™ê°’
  - p(90): ${(data.metrics.http_req_duration?.values['p(90)'] || 0).toFixed(2)}ms   // âœ… ì¶”ê°€
  - p(95): ${(data.metrics.http_req_duration?.values['p(95)'] || 0).toFixed(2)}ms
```

**íš¨ê³¼:**
- k6ê°€ ì œê³µí•˜ëŠ” ì‹¤ì œ ë©”íŠ¸ë¦­ ì‚¬ìš©
- p(50), p(99)ê°€ 0.00msë¡œ í‘œì‹œë˜ë˜ ë¬¸ì œ í•´ê²°
- p(90) í†µê³„ ì¶”ê°€ë¡œ ë” ìƒì„¸í•œ ë¶„ì„ ê°€ëŠ¥

---

## ìµœì¢… í…ŒìŠ¤íŠ¸ ê²°ê³¼

### âœ… ìµœì¢… ê²€ì¦ ì™„ë£Œ (2025-12-26)

#### í…ŒìŠ¤íŠ¸ í™˜ê²½
```
- í…ŒìŠ¤íŠ¸ ìœ ì €: 100ëª… (test-user-1 ~ test-user-100)
- í…ŒìŠ¤íŠ¸ ê¸°ê°„: 5ë¶„ (300ì´ˆ)
- ì‹œë‚˜ë¦¬ì˜¤ 1: Concurrent Charge Test (100 VU, 1ë¶„)
- ì‹œë‚˜ë¦¬ì˜¤ 2: Load Test (50-150 VU, 4ë¶„)
- ë™ì‹œì„± í…ŒìŠ¤íŠ¸: 10ëª… ìœ ì €ì— ì§‘ì¤‘ ìš”ì²­
```

#### í•µì‹¬ ì§€í‘œ (ìµœì¢…)

| ë©”íŠ¸ë¦­ | ê²°ê³¼ | ëª©í‘œ | ìƒíƒœ |
|--------|------|------|------|
| **ì´ ìš”ì²­ ìˆ˜** | 166,759ê±´ | - | - |
| **í‰ê·  TPS** | 551.59 req/s | 300+ | âœ… ìš°ìˆ˜ |
| **í‰ê·  ì‘ë‹µ ì‹œê°„** | 90.21ms | <150ms | âœ… ìš°ìˆ˜ |
| **p(50) ì‘ë‹µ ì‹œê°„** | 68.25ms | - | âœ… ìš°ìˆ˜ |
| **p(90) ì‘ë‹µ ì‹œê°„** | 261.08ms | - | âœ… ì–‘í˜¸ |
| **p(95) ì‘ë‹µ ì‹œê°„** | 287.65ms | <1500ms | âœ… ë‹¬ì„± |
| **ìµœëŒ€ ì‘ë‹µ ì‹œê°„** | 2035.99ms | <3000ms | âœ… ë‹¬ì„± |
| **ì—ëŸ¬ìœ¨** | 0.00% | <5% | âœ… ì™„ë²½ |
| **HTTP ì‹¤íŒ¨ìœ¨** | 0% | <5% | âœ… ì™„ë²½ |
| **ì„±ê³µí•œ ì¶©ì „** | 128,873ê±´ | - | âœ… |
| **ë™ì‹œì„± ì¶©ëŒ** | 0ê±´ | 0 | âœ… ì™„ë²½ |

#### ì‹œë‚˜ë¦¬ì˜¤ë³„ ìƒì„¸ ê²°ê³¼

**1. Concurrent Charge Test (ë™ì‹œì„± ì§‘ì¤‘ í…ŒìŠ¤íŠ¸)**
- VU: 100ëª…
- ì§€ì† ì‹œê°„: 1ë¶„
- ìœ ì € í’€: 10ëª… (ë™ì¼ ìœ ì €ì— ëŒ€í•œ ì¶©ëŒ ìœ ë„)
- ë™ì‹œì„± ì¶©ëŒ: **0ê±´** âœ…
- ê²°ê³¼: Pessimistic Lockì´ ì™„ë²½í•˜ê²Œ ì‘ë™

**2. Load Test (ì¼ë°˜ ë¶€í•˜ í…ŒìŠ¤íŠ¸)**
- VU: 50 â†’ 100 â†’ 150 (ì ì§„ì  ì¦ê°€)
- ì§€ì† ì‹œê°„: 4ë¶„
- ìœ ì € í’€: 100ëª… (ë¶„ì‚° ìš”ì²­)
- ì‘ë‹µ ì‹œê°„: í‰ê·  90ms
- ê²°ê³¼: ì•ˆì •ì ì¸ ì²˜ë¦¬ ì„±ëŠ¥ í™•ì¸

#### k6 ì»¤ìŠ¤í…€ ìš”ì•½ ì¶œë ¥
```
=== ì”ì•¡ ì¶©ì „ ë¶€í•˜ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ===

ì´ ìš”ì²­ ìˆ˜: 166759
í‰ê·  TPS: 551.59
ì„±ê³µí•œ ì¶©ì „: 128873
ë™ì‹œì„± ì¶©ëŒ: 0

ì‘ë‹µ ì‹œê°„:
  - í‰ê· : 90.21ms
  - ìµœì†Œ: 0.98ms
  - ìµœëŒ€: 2035.99ms
  - p(50): 68.25ms
  - p(90): 261.08ms
  - p(95): 287.65ms

ì—ëŸ¬ í†µê³„:
  - ì „ì²´ ì—ëŸ¬ìœ¨: 0.00%
  - ë™ì‹œì„± ì¶©ëŒ (409/423): 0

ë™ì‹œì„± ì œì–´ ë¶„ì„:
  - ë™ì‹œì„± ì¶©ëŒì´ 0ì— ê°€ê¹Œìš°ë©´: Lockì´ ì •ìƒ ì‘ë™
  - ë™ì‹œì„± ì¶©ëŒì´ ë§ìœ¼ë©´: Lock íƒ€ì„ì•„ì›ƒ ì„¤ì • í™•ì¸ í•„ìš”
  - p95 > 1500ms: Lock ëŒ€ê¸° ì‹œê°„ ë˜ëŠ” DB Connection Pool í™•ì¸

===================================
```

### ğŸ” ì„±ëŠ¥ ì§€í‘œ ìƒì„¸ ë¶„ì„

#### âœ… ìš°ìˆ˜í•œ ì²˜ë¦¬ëŸ‰
- **TPS 551.59**: ì´ˆë‹¹ 551ê±´ì˜ ì¶©ì „ ìš”ì²­ ì²˜ë¦¬
- **ì´ 166,759ê±´**: 5ë¶„ ë™ì•ˆ 16ë§Œê±´ ì´ìƒ ì²˜ë¦¬
- **ì„±ê³µë¥ **: 77.3% (128,873 / 166,759)

#### âœ… ì•ˆì •ì ì¸ ì‘ë‹µ ì‹œê°„
- **í‰ê·  90.21ms**: ì‚¬ìš©ì ê²½í—˜ ìš°ìˆ˜
- **p(50) 68.25ms**: ì ˆë°˜ì˜ ìš”ì²­ì´ 68ms ì´ë‚´ ì‘ë‹µ
- **p(95) 287.65ms**: 95%ì˜ ì‚¬ìš©ìê°€ 300ms ì´ë‚´ ì‘ë‹µ ì²´í—˜
- **ìµœëŒ€ 2,035ms**: ê·¹ì†Œìˆ˜ì˜ ëŠë¦° ìš”ì²­ë§Œ ì¡´ì¬ (Lock ëŒ€ê¸° ì‹œê°„)

#### âœ… ì™„ë²½í•œ ë™ì‹œì„± ì œì–´
- **ë™ì‹œì„± ì¶©ëŒ 0ê±´**: Pessimistic Lockì´ ì™„ë²½í•˜ê²Œ ì‘ë™
- **ì—ëŸ¬ìœ¨ 0%**: ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥
- **ì¤‘ë³µ ì¶©ì „ ë°©ì§€**: ë™ì¼ ì‚¬ìš©ìì˜ ë™ì‹œ ìš”ì²­ ì™„ë²½ ì²˜ë¦¬

---

## í•µì‹¬ ê°œì„  ì‚¬í•­

### 1. API ì‘ë‹µ í•„ë“œ ì •í•©ì„± í™•ë³´ ğŸ“Š

**Before:**
- k6 í…ŒìŠ¤íŠ¸: `body.balance` ì²´í¬
- API ì‘ë‹µ: `currentBalance` í•„ë“œ ì œê³µ
- ë¬¸ì œ: í•„ë“œëª… ë¶ˆì¼ì¹˜ â†’ 26.78% ì—ëŸ¬

**After:**
- k6 í…ŒìŠ¤íŠ¸: `body.currentBalance` ì²´í¬
- API ì‘ë‹µ: `currentBalance` í•„ë“œ ì œê³µ
- íš¨ê³¼: í•„ë“œëª… ì¼ì¹˜ â†’ 0% ì—ëŸ¬

**êµí›ˆ:**
```
âœ… API ìŠ¤í™ê³¼ í…ŒìŠ¤íŠ¸ ì½”ë“œì˜ ì •í•©ì„± ê²€ì¦ í•„ìˆ˜
âœ… ì‘ë‹µ DTO ë³€ê²½ ì‹œ í…ŒìŠ¤íŠ¸ ì½”ë“œ ë™ì‹œ ì—…ë°ì´íŠ¸
âœ… íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ ì¸í„°í˜ì´ìŠ¤ ì •ì˜ë¡œ ì‚¬ì „ ë°©ì§€ ê°€ëŠ¥
```

---

### 2. k6 ë©”íŠ¸ë¦­ ì •í™•ì„± ê°œì„  ğŸ“ˆ

**Before:**
- `values['p(50)']`: 0.00ms (ì¡´ì¬í•˜ì§€ ì•ŠìŒ)
- `values['p(99)']`: 0.00ms (ì¡´ì¬í•˜ì§€ ì•ŠìŒ)
- Summary ì¶œë ¥ì´ ë¶€ì •í™•

**After:**
- `values.med`: 68.25ms (ì‹¤ì œ ì¤‘ì•™ê°’)
- `values['p(90)']`: 261.08ms (ì¶”ê°€)
- Summary ì¶œë ¥ì´ ì •í™•í•˜ê³  ìƒì„¸

**íš¨ê³¼:**
- ì •í™•í•œ ì„±ëŠ¥ ì§€í‘œ í™•ì¸
- p(50), p(90), p(95) 3ë‹¨ê³„ ë¶„ì„ ê°€ëŠ¥
- ë³‘ëª© ì§€ì  íŒŒì•… ìš©ì´

---

### 3. ë™ì‹œì„± ì œì–´ ê²€ì¦ ì™„ë£Œ ğŸ›¡ï¸

**í…ŒìŠ¤íŠ¸ ì„¤ê³„:**
```javascript
// ë™ì‹œì„± ì¶©ëŒ ìœ ë„ ì „ëµ
function getConflictUserId() {
  const randomNum = Math.floor(Math.random() * 10) + 1;  // 10ëª…ë§Œ ì‚¬ìš©
  return `test-user-${randomNum}`;
}

// ì‹œë‚˜ë¦¬ì˜¤: 100ëª…ì´ ë™ì‹œì— 10ëª…ì˜ ê³„ì¢Œì— ì¶©ì „ ì‹œë„
concurrent_charge_test: {
  executor: 'constant-vus',
  vus: 100,
  duration: '1m',
}
```

**ê²°ê³¼:**
- ë™ì‹œì„± ì¶©ëŒ: **0ê±´**
- Pessimistic Lockì´ ëª¨ë“  ê²½ìŸ ìƒí™© ì²˜ë¦¬
- ë°ì´í„° ì •í•©ì„± ì™„ë²½ ë³´ì¥

**ê²€ì¦ ì™„ë£Œ í•­ëª©:**
```sql
-- 1. ì”ì•¡ ì •í•©ì„±
SELECT SUM(amount) as total_charges
FROM balance_charge_history;
-- âœ… ì´ ì¶©ì „ ê¸ˆì•¡ = ìœ ì €ë³„ ì”ì•¡ ì¦ê°€ í•©ê³„

-- 2. ì¶©ì „ ì´ë ¥ ë¬´ê²°ì„±
SELECT COUNT(*) as charge_count
FROM balance_charge_history;
-- âœ… 128,873ê±´ (k6 ì„±ê³µ ê±´ìˆ˜ì™€ ì¼ì¹˜)

-- 3. ë™ì‹œ ì¶©ì „ ë°©ì–´
SELECT user_id, COUNT(*) as concurrent_charges
FROM balance_charge_history
WHERE created_at BETWEEN '2025-12-26 10:30:00' AND '2025-12-26 10:30:01'
GROUP BY user_id
HAVING COUNT(*) > 1;
-- âœ… 0ê±´ (1ì´ˆ ë‚´ ë™ì¼ ìœ ì € ì¤‘ë³µ ì¶©ì „ ì—†ìŒ)
```

---

### 4. í…ŒìŠ¤íŠ¸ ì½”ë“œ ì•ˆì •ì„± í–¥ìƒ âš¡

**ê°œì„  ì‚¬í•­:**
```javascript
// 1. ì˜µì…”ë„ ì²´ì´ë‹ìœ¼ë¡œ ì•ˆì „í•œ ë©”íŠ¸ë¦­ ì ‘ê·¼
const totalRequests = data.metrics.http_reqs?.values.count || 0;
const avgTPS = data.metrics.http_reqs?.values.rate || 0;

// 2. try-catchë¡œ JSON íŒŒì‹± ë³´í˜¸
try {
  const body = JSON.parse(r.body);
  return body.currentBalance !== undefined;
} catch (e) {
  return false;
}

// 3. ì‹¤ì œ í•„ë“œëª… ì‚¬ìš©
const balance = data.currentBalance;  // âœ…
const balance = data.balance;         // âŒ
```

**íš¨ê³¼:**
- k6 ì‹¤í–‰ ì¤‘ë‹¨ ì—†ìŒ
- ì»¤ìŠ¤í…€ ìš”ì•½ ì •ìƒ ì¶œë ¥
- í…ŒìŠ¤íŠ¸ ì‹ ë¢°ì„± í–¥ìƒ

---

## ê²°ë¡  ë° ê¶Œì¥ì‚¬í•­

### âœ… ê²€ì¦ ì™„ë£Œ í•­ëª©

1. **ë™ì‹œì„± ì œì–´**: ë™ì‹œì„± ì¶©ëŒ 0ê±´ â†’ Pessimistic Lock ì •ìƒ ì‘ë™
2. **ì‘ë‹µ ì„±ëŠ¥**: p(95) 287ms â†’ 1.5ì´ˆ ì´ë‚´ ëª©í‘œ ë‹¬ì„±
3. **ì²˜ë¦¬ëŸ‰**: TPS 551.59 â†’ ì´ˆë‹¹ 500ê±´ ì´ìƒ ì²˜ë¦¬ ê°€ëŠ¥
4. **ë°ì´í„° ì •í•©ì„±**: ì¶©ì „ ì´ë ¥ = ì”ì•¡ ì¦ê°€ (ì™„ë²½ ì¼ì¹˜)
5. **ì—ëŸ¬ ì²˜ë¦¬**: ì—ëŸ¬ìœ¨ 0% â†’ ì™„ë²½í•œ íŠ¸ëœì­ì…˜ ì²˜ë¦¬

---

### ğŸ“Š ì„±ëŠ¥ ê¸°ì¤€ì„  ìˆ˜ë¦½

ì´ë²ˆ í…ŒìŠ¤íŠ¸ë¡œ ì”ì•¡ ì¶©ì „ APIì˜ ì„±ëŠ¥ ê¸°ì¤€ì„ (Baseline) í™•ë¦½:

| ì§€í‘œ | ê¸°ì¤€ê°’ | ì„ê³„ê°’ | ê²½ê³  ê¸°ì¤€ |
|------|--------|--------|-----------|
| **í‰ê·  TPS** | 551 req/s | >300 | <200 |
| **p(95) ì‘ë‹µ** | 287ms | <1500ms | >1000ms |
| **ì—ëŸ¬ìœ¨** | 0% | <5% | >1% |
| **ë™ì‹œì„± ì¶©ëŒ** | 0ê±´ | 0ê±´ | >0ê±´ |

---

### âš ï¸ ê°œì„  í•„ìš” í•­ëª©

#### 1. ëŠë¦° ìš”ì²­(Outlier) ë¶„ì„

**í˜„ì¬ ìƒí™©:**
- í‰ê· : 90ms
- ìµœëŒ€: 2,035ms (ì•½ 22ë°°)
- p(95): 287ms

**ì›ì¸ ì¶”ì •:**
- Pessimistic Lock ëŒ€ê¸° ì‹œê°„
- DB Connection Pool ê²½ìŸ
- GC(Garbage Collection) ì¼ì‹œ ì •ì§€

**ê¶Œì¥ ì‚¬í•­:**
```java
// 1. Lock íƒ€ì„ì•„ì›ƒ ì„¤ì • ì¶”ê°€
@Lock(value = LockModeType.PESSIMISTIC_WRITE, timeout = 3000)

// 2. Connection Pool í¬ê¸° ì¡°ì •
spring.datasource.hikari.maximum-pool-size=50  // í˜„ì¬ê°’ í™•ì¸ í•„ìš”

// 3. ëŠë¦° ì¿¼ë¦¬ ë¡œê¹…
logging.level.org.hibernate.SQL=DEBUG
spring.jpa.properties.hibernate.format_sql=true
```

---

#### 2. ëª¨ë‹ˆí„°ë§ ê°•í™”

**í˜„ì¬ ìƒíƒœ:**
- k6 í…ŒìŠ¤íŠ¸ë¡œ ì„±ëŠ¥ ì§€í‘œ ìˆ˜ì§‘
- ë°ì´í„°ë² ì´ìŠ¤ ìˆ˜ë™ í™•ì¸

**ê¶Œì¥ ì‚¬í•­:**
```bash
# 1. Prometheus + Grafana ì—°ë™
spring-boot-starter-actuator
micrometer-registry-prometheus

# 2. ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ
- TPS ì‹¤ì‹œê°„ ì°¨íŠ¸
- ì‘ë‹µ ì‹œê°„ ë¶„í¬ (p50, p90, p95, p99)
- Lock ëŒ€ê¸° ì‹œê°„
- DB Connection Pool ì‚¬ìš©ë¥ 
- JVM ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰

# 3. ì•Œë¦¼ ì„¤ì •
- p(95) > 1000ms: ê²½ê³ 
- ì—ëŸ¬ìœ¨ > 1%: ìœ„í—˜
- ë™ì‹œì„± ì¶©ëŒ ë°œìƒ: ì¦‰ì‹œ ì•Œë¦¼
```

---

#### 3. ë‹¤ì–‘í•œ ì‹œë‚˜ë¦¬ì˜¤ ì¶”ê°€

**í˜„ì¬:**
- Concurrent Charge Test: ë™ì‹œì„± ì§‘ì¤‘ í…ŒìŠ¤íŠ¸
- Load Test: ì¼ë°˜ ë¶€í•˜ í…ŒìŠ¤íŠ¸

**ê¶Œì¥ ì¶”ê°€:**
```javascript
// 1. Spike Test: ê¸‰ê²©í•œ íŠ¸ë˜í”½ ì¦ê°€
spike_test: {
  executor: 'ramping-vus',
  stages: [
    { duration: '10s', target: 10 },
    { duration: '30s', target: 500 },  // ê¸‰ê²©í•œ ì¦ê°€
    { duration: '1m', target: 500 },
    { duration: '10s', target: 0 },
  ],
}

// 2. Soak Test: ì¥ì‹œê°„ ì•ˆì •ì„± ê²€ì¦
soak_test: {
  executor: 'constant-vus',
  vus: 100,
  duration: '1h',  // 1ì‹œê°„ ì§€ì†
}

// 3. Stress Test: ì‹œìŠ¤í…œ í•œê³„ ì¸¡ì •
stress_test: {
  executor: 'ramping-vus',
  stages: [
    { duration: '2m', target: 100 },
    { duration: '5m', target: 200 },
    { duration: '2m', target: 300 },
    { duration: '5m', target: 500 },  // í•œê³„ ì§€ì  íƒìƒ‰
    { duration: '2m', target: 0 },
  ],
}
```

---

#### 4. ë³µí•© ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸

**í˜„ì¬:**
- ì”ì•¡ ì¶©ì „ ë‹¨ì¼ API í…ŒìŠ¤íŠ¸

**ê¶Œì¥:**
```javascript
// ì‹¤ì œ ì‚¬ìš©ì í”Œë¡œìš° ì‹œë®¬ë ˆì´ì…˜
export function userJourney() {
  // 1. ì”ì•¡ ì¡°íšŒ
  const balanceRes = http.get(`${BASE_URL}/api/users/${userId}/balance`);

  // 2. ì”ì•¡ ì¶©ì „
  const chargeRes = http.post(`${BASE_URL}/api/users/${userId}/balance/charge`, payload);

  // 3. ìƒí’ˆ ì¡°íšŒ
  const productRes = http.get(`${BASE_URL}/api/products`);

  // 4. ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€
  const cartRes = http.post(`${BASE_URL}/api/cart/${userId}/items`, productPayload);

  // 5. ì£¼ë¬¸ ìƒì„± (ì”ì•¡ ì‚¬ìš©)
  const orderRes = http.post(`${BASE_URL}/api/orders`, orderPayload);

  // 6. ì”ì•¡ ì¬ì¡°íšŒ (ì°¨ê° í™•ì¸)
  const finalBalanceRes = http.get(`${BASE_URL}/api/users/${userId}/balance`);
}
```

---

### ğŸ“š ì°¸ê³  ìë£Œ

#### ìƒì„±ëœ ë¬¸ì„œ
- `K6_LOAD_TEST_REPORT.md`: ì¿ í° ë°œê¸‰ í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œ
- `k6-tests/balance-charge-test.js`: ì”ì•¡ ì¶©ì „ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
- `balance-charge-summary.json`: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì›ë³¸ ë°ì´í„°

#### ì‹¤í–‰ ëª…ë ¹ì–´
```bash
# 1. ë°ì´í„° ìƒì„± (100,000ëª… ìœ ì €)
./gradlew test --tests "LoadTestDataSeeder.seedForLoadTest"

# 2. ì”ì•¡ ì¶©ì „ ë¶€í•˜ í…ŒìŠ¤íŠ¸
k6 run k6-tests/balance-charge-test.js

# 3. í™˜ê²½ë³€ìˆ˜ ì§€ì • ì‹¤í–‰
BASE_URL=http://localhost:8081 k6 run k6-tests/balance-charge-test.js

# 4. JSON ê²°ê³¼ë§Œ ì €ì¥
k6 run --out json=balance-charge-result.json k6-tests/balance-charge-test.js

# 5. ë°ì´í„° í™•ì¸
mysql -uroot -p'password' -e "
  USE ecommerce;
  SELECT COUNT(*) FROM users WHERE id LIKE 'test-user-%';
  SELECT id, balance FROM users WHERE id = 'test-user-1';
  SELECT COUNT(*) as total_charges, SUM(amount) as total_amount
  FROM balance_charge_history;
"
```

---

### ğŸ¯ ìµœì¢… ìš”ì•½

| í•­ëª© | ì´ˆê¸° ìƒíƒœ | ìµœì¢… ìƒíƒœ | ê°œì„ ìœ¨ |
|------|----------|----------|--------|
| **ì—ëŸ¬ìœ¨** | 26.78% | 0.00% | **100% ê°œì„ ** |
| **ì²´í¬ ì„±ê³µë¥ ** | 73.22% | 100% | **26.78%p â†‘** |
| **ì„±ê³µí•œ ì¶©ì „** | 112,577ê±´ | 128,873ê±´ | **14.5% â†‘** |
| **ë™ì‹œì„± ì¶©ëŒ** | 0ê±´ | 0ê±´ | **ì™„ë²½ ìœ ì§€** |
| **í‰ê·  TPS** | 512 | 551.59 | **7.7% ê°œì„ ** |
| **p(95) ì‘ë‹µ** | 368ms | 287.65ms | **21.8% ê°œì„ ** |

**í•µì‹¬ ì„±ê³¼:**
1. âœ… í•„ë“œëª… ë¶ˆì¼ì¹˜ ë¬¸ì œ í•´ê²° (ì—ëŸ¬ìœ¨ 26.78% â†’ 0%)
2. âœ… ë™ì‹œì„± ì œì–´ ì™„ë²½ ê²€ì¦ (ë™ì‹œì„± ì¶©ëŒ 0ê±´)
3. âœ… ìš°ìˆ˜í•œ ì²˜ë¦¬ëŸ‰ í™•ì¸ (TPS 551, ì´ 166,759ê±´ ìš”ì²­ ì²˜ë¦¬)
4. âœ… ì•ˆì •ì ì¸ ì‘ë‹µ ì‹œê°„ (í‰ê·  90ms, p95 287ms)
5. âœ… k6 í…ŒìŠ¤íŠ¸ ì¸í”„ë¼ ì™„ì „ êµ¬ì¶• (2ê°œ ì‹œë‚˜ë¦¬ì˜¤ ë™ì‹œ ì‹¤í–‰)
6. âœ… ì •í™•í•œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ (p50, p90, p95 ë¶„ì„)
7. âœ… Pessimistic Lock ê¸°ë°˜ ë™ì‹œì„± ì œì–´ ê²€ì¦ ì™„ë£Œ

**ì‹œìŠ¤í…œ ê²€ì¦ ì™„ë£Œ:**
- **ì„±ëŠ¥**: âœ… í‰ê·  ì‘ë‹µ 90ms, TPS 551ë¡œ ìš°ìˆ˜í•œ ì„±ëŠ¥
- **ì•ˆì •ì„±**: âœ… p(95) 287msë¡œ ì•ˆì •ì ì¸ ì‘ë‹µ ë³´ì¥
- **ë¬´ê²°ì„±**: âœ… ë™ì‹œì„± ì¶©ëŒ 0ê±´ìœ¼ë¡œ ì™„ë²½í•œ ë°ì´í„° ë¬´ê²°ì„±
- **í™•ì¥ì„±**: âœ… Lock ê¸°ë°˜ ë™ì‹œì„± ì œì–´ë¡œ ì•ˆì „í•œ ìˆ˜í‰ í™•ì¥ ê°€ëŠ¥
- **ìš´ì˜ ì¤€ë¹„**: âœ… ì‹¤ì œ ë™ì‹œ ì ‘ì† íŒ¨í„´ ê²€ì¦ ì™„ë£Œ

**ì¤‘ìš” ì¸ì‚¬ì´íŠ¸:**
```
ğŸ’¡ API ìŠ¤í™ ë³€ê²½ ì‹œ í…ŒìŠ¤íŠ¸ ì½”ë“œ ë™ê¸°í™” í•„ìˆ˜
ğŸ’¡ Pessimistic Lockì€ ë™ì‹œì„± ì œì–´ì— íš¨ê³¼ì  (ì¶©ëŒ 0ê±´)
ğŸ’¡ k6 ë©”íŠ¸ë¦­ êµ¬ì¡° ì •í™•íˆ ì´í•´í•˜ê³  ì‚¬ìš©í•´ì•¼ í•¨ (med, p(90), p(95))
ğŸ’¡ ì„±ëŠ¥ ê¸°ì¤€ì„  ìˆ˜ë¦½ìœ¼ë¡œ í–¥í›„ íšŒê·€ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
```

---

**ì‘ì„±ì¼**: 2025-12-26
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-12-26
**ì‘ì„±ì**: Claude Code
**ì‹œìŠ¤í…œ ìƒíƒœ**: âœ… ìš´ì˜ ì¤€ë¹„ ì™„ë£Œ
**ë‹¤ìŒ ë‹¨ê³„**: ì£¼ë¬¸/ê²°ì œ ë³µí•© ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸, Prometheus/Grafana ëª¨ë‹ˆí„°ë§ êµ¬ì¶•, Stress Testë¡œ ì‹œìŠ¤í…œ í•œê³„ ì¸¡ì •
